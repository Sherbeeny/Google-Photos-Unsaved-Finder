const puppeteer = require('puppeteer');
const fs = require('fs');
const path = require('path');
const { execSync } = require('child_process');

describe('Google Photos Saved Finder', () => {
  let browser;
  let page;
  let popup;

  beforeEach(async () => {
    console.log('Building userscript...');
    execSync('npm run build');
    console.log('Build complete.');

    browser = await puppeteer.launch({
      headless: true,
      args: ['--no-sandbox', '--disable-setuid-sandbox']
    });
    page = await browser.newPage();

    page.on('console', msg => console.log('PAGE LOG:', msg.text()));

    const userscript = fs.readFileSync(path.resolve(__dirname, '../dist/gpsf.user.js'), 'utf8');

    await page.goto('about:blank');

    await page.evaluate(() => {
      console.log('This is a test log from within the page context');
      window.E2E_TESTING = true;
      window.unsafeWindow = window;
      window.gptkApi = {
        getItemInfo: (mediaKey) => {
          if (mediaKey === 'item1') {
            return Promise.resolve({ mediaKey: 'item1', filename: 'saved.jpg', url: 'https://lh3.googleusercontent.com/12345', savedToYourPhotos: true });
          }
          return Promise.resolve({ mediaKey: 'item2', filename: 'not-saved.jpg', url: 'https://lh3.googleusercontent.com/67890', savedToYourPhotos: false });
        }
      };
      window.gptkApiUtils = {
        getAllAlbums: () => Promise.resolve([
          { mediaKey: 'album1', title: 'Test Album', itemCount: 2 }
        ]),
        getAllMediaInAlbum: () => Promise.resolve([
          { mediaKey: 'item1' },
          { mediaKey: 'item2' }
        ]),
        addToExistingAlbum: () => Promise.resolve(),
        createAlbum: () => Promise.resolve('new-album-id'),
      };
    });

    const popupPromise = new Promise(resolve => browser.on('targetcreated', async target => {
        if (target.type() === 'page') {
            const newPage = await target.page();
            resolve(newPage);
        }
    }));

    await page.addScriptTag({ content: userscript });

    popup = await popupPromise;
    popup.on('console', msg => console.log('POPUP LOG:', msg.text()));

    await popup.waitForSelector('#gpsf-album-album1', { visible: true });
  });

  afterEach(async () => {
    await browser.close();
  });

  test('should find saved photos', async () => {
    await popup.click('input[value="saved"]');
    await popup.click('#gpsf-album-album1');
    await popup.click('#gpsf-start-button');

    await popup.waitForSelector('#gpsf-results-container img');

    const photoUrls = await popup.evaluate(() => {
      const images = Array.from(document.querySelectorAll('#gpsf-results-container img'));
      return images.map(img => img.src);
    });
    console.log('Found photo URLs:', photoUrls);

    expect(photoUrls).toHaveLength(1);
    expect(photoUrls[0]).toBe('https://lh3.googleusercontent.com/12345');
  });

  test('should find not-saved photos', async () => {
    await popup.click('input[value="not-saved"]');
    await popup.click('#gpsf-album-album1');
    await popup.click('#gpsf-start-button');

    await popup.waitForSelector('#gpsf-results-container img');

    const photoUrls = await popup.evaluate(() => {
      const images = Array.from(document.querySelectorAll('#gpsf-results-container img'));
      return images.map(img => img.src);
    });
    console.log('Found photo URLs:', photoUrls);

    expect(photoUrls).toHaveLength(1);
    expect(photoUrls[0]).toBe('https://lh3.googleusercontent.com/67890');
  });
});
